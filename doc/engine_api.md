# Nano.AI Engine API (v0.5)

****
## Data Structure


- **Version**
```c
#define NANOAI_VERSION_MAJOR 0
#define NANOAI_VERSION_MINOR 5
```

- **NanoAi model graph structure**
```c
typedef struct {
    void* data; /* NanoAi graph object */
} NanoAi;
```

- **NanoAi error definition**
```c
typedef enum {
    NANOAI_ERROR_OK = 0, /* success */
    NANOAI_ERROR, /* generic error */
    NANOAI_ERROR_AUTHENTICATE_FAILED, /* authenticate failed */
    NANOAI_ERROR_INTERNAL = 100, /* internal error */
    NANOAI_ERROR_INVALID_PARAM = 200, /* invalid parameters */
    NANOAI_ERROR_MODEL_INCOMPATIBLE, /* incompatible model with the engine */
    NANOAI_ERROR_MODEL_CORRUPT, /* corrupted model */
    NANOAI_ERROR_MODEL_CORRUPT_WEIGHTS, /* corrupted weights */
    NANOAI_ERROR_MODEL_CORRUPT_BIAS /* corrupted bias */
} NanoAiError;
```

- **NanoAi model graph attributes**
```c
typedef struct {
    uint16_t version; /* version of the NanoAi model */
    uint32_t requiredMem; /* required graph memory size for the model */
    void* reserved; /* reserved */
} NanoAiGraphAttributes;
```

- **NanoAi model graph blobs attributes**
```c
typedef struct {
    uint16_t version; /* version of the NanoAi model */
    uint32_t requiredMem; /* required blobs memory size for the model */
    void* reserved; /* reserved */
} NanoAiBlobsAttributes;
```

- **Input pixel format**
```c
typedef enum NanoAiPixelFormat {
    PIXEL_RGB = 0, /* RGB888 big endian */
    PIXEL_BGR, /* BGR888 big endian */
    PIXEL_GRAY, /* Gray8 */
} NanoAiPixelFormat;
```

- **The NanoAi output data**
```c
typedef struct NanoAiOutput {
    unsigned int c; /* chanel */
    unsigned int h; /* height */
    unsigned int w; /* width */
    float* data; /* float data */
} NanoAiOutput;
```
****

## API

- **To get model graph attributes of a NanoAi model**
   - `@param *pModel [in]`  Pointer to the NanoAi model array generated by NanoAi converter.
   - `@param *pGraphAttributes [in/out]`    Pointer to the NanoAiGraphAttributes structure to hold the model's graph attributes.
   - `@returns NANOAI_ERROR_OK` for the success.
```c
APIDEC NanoAiError NanoAi_GetGraphAttributes(const unsigned char* pModel, NanoAiGraphAttributes* pGraphAttributes);
```

- **To create a NanoAi model graph**
  - `@param *pModel [in]`  Pointer to the NanoAi model array generated by NanoAi converter.
  - `@param *pModel [in]`  Pointer to the NanoAi model data array generated by NanoAi converter.
  - `@param *pGraphMem [in]`   Pointer to the buffer with the size queried by NanoAi_GetGraphAttributes API. The buffer should have the same life cycle as the NanoAi model.
  - `@param *pNanoAi [in/out]`   Pointer to the NanoAi structure to hold the NanoAi model graph.
  - `@returns NANOAI_ERROR_OK` for the success.

```c
APIDEC NanoAiError NanoAi_CreateGraph(const unsigned char* pModel, const unsigned char* pModelData, unsigned char* pGraphMem, NanoAi* pNanoAi);
```

- **To get the model blobs attributes of the NanoAi model**
  - `@param *pNanoAi [in]`  Pointer to the NanoAi structure created by NanoAi_CreateGraphr.
  - `@param c [in]`    The chanel of the input, set c, h, w to 0 to use the input's resolution in the model. 
  - `@param h [in]`    The height of the input, set c, h, w to 0 to use the input's resolution in the model.
  - `@param w [in]`   The width of the input, set c, h, w to 0 to use the input's resolution in the model.
  - `@param *pBlobsAttributes [in/out]`    Pointer to the NanoAiBlobsAttributes structureto hold the blobs attributes of the NanoAi model.
   - `@returns NANOAI_ERROR_OK` for the success.

 ```c
APIDEC NanoAiError NanoAi_GetBlobsAttributes(NanoAi* pNanoAi, int c, int h, int w, NanoAiBlobsAttributes* pBlobsAttributes);
 ```

- **To create NanoAi graph blobs with requested memory**
  - `@param *pNanoAi [in]`  Pointer to the NanoAi structure created by NanoAi_CreateGraphr.
  - `@param *pGraphMem [in]`   Pointer to the buffer with the size queried by NanoAi_GetBlobsAttributes API. The buffer should have the same life cycle as the NanoAi model.
  - `@returns NANOAI_ERROR_OK` for the success.

```c
APIDEC NanoAiError NanoAi_CreateBlobs(NanoAi* pNanoAi, unsigned char* pBlobsMem);
```

- **To specifiy the input data for the NanoAi model**
  - `@param *pNanoAi [in]`  Pointer to the NanoAi structure which was created by NanoAi_CreateGraphr API.
  - `@param *pPixels [in]`   Pointer to the pixel data.
  - `@param format [in]`   The Pixel format.
  - `@param h [in]`   The height of the pixel data.
  - `@param w [in]`   The width of the pixel data.
  - `@param *pMeans [in]`   The means array for input pre-processing, NULL to bypass the mean pre-processing.
  - `@param *pNormals [in]`   The normalization array for input pre-processing, NULL to bypass the nornalization.
  - `@returns NANOAI_ERROR_OK` for the success.

```c
APIDEC NanoAiError NanoAi_Input(NanoAi* pNanoAi, const unsigned char* pPixels, NanoAiPixelFormat format, int h, int w, const float* pMeans, const float* pNorms);
```

- **To do the inference and get output**

   NanoAi always executes all the dependency layers for the output.

  - `@param *pNanoAi [in]`  Pointer to the NanoAi structure created by NanoAi_CreateGraphr API.
  - `@param outputBlobID [in]`    The output blob id generated with the NanoAi model converter.
  - `@param *pOutput [in/out]`    Output, the buffer will be overwritten for each forward call.
  - `@returns NANOAI_ERROR_OK` for the success.

```c
APIDEC NanoAiError NanoAi_Forward(NanoAi* pNanoAi, int outputBlobID, NanoAiOutput* pOutput);
```

- **To extract output based on the previously forwarded data**
  
   The engine won't execute the dependency layer if it has already been executed in the previous NanoAi_Forward call. It is same as NanoAi_Forward if the model only has one output. For the multiple outputs, use the NanoAi_Forward to get one output, and following the NanoAi_Extract calls to get others.
  - `@param *pNanoAi [in]`  Pointer to the NanoAi structure which was created by NanoAi_CreateGraphr API.
  - `@param outputBlobID [in]`    The output blob id generated with the NanoAi model converter.
  - `@param *pOutput [in/out]`    The output to be filled, the output buffer will be overwritten for each forward/Extract call.
  - `@returns NANOAI_ERROR_OK` for the success.
  
```c
APIDEC NanoAiError NanoAi_Extract(NanoAi* pNanoAi, int outputBlobID, NanoAiOutput* pOutput);
```

****
## Reference code [[whole reference code](../benchmark/src/unit_lenet.c)]
   Take lenet for example:

- **Include the nanoai modle** 
  
  Include the int8 or float nanoai model header file.

```c
#if LENET_INT8
   #include "lenet/lenet_int8_nanoai.h"
   #define NANOAI_MODEL_INSTANCE  lenet_int8_binary_model
   #define NANOAI_MODEL_DATA_INSTANCE lenet_int8_binary_model_data
   #define NANOAI_MODEL_OUTPUT_ID LENET_INT8_B_PROB_ID
#else
   #include "lenet/lenet_nanonn.h"
   #define NANOAI_MODEL_INSTANCE  lenet_binary_model
   #define NANOAI_MODEL_DATA_INSTANCE lenet_binary_model_data
   #define NANOAI_MODEL_OUTPUT_ID LENET_B_PROB_ID
#endif
```

- **Setup the nanoai graph and blobs** 

```c
   NanoAiError nError = NANOAI_ERROR_OK;
   NanoAiGraphAttributes graphAttributes;
   NanoAiBlobsAttributes blobsAttributes;
   NanoAi nGraph;

   // query the graph attributes
   nError = NanoAi_GetGraphAttributes(NANOAI_MODEL_INSTANCE, &graphAttributes);
   if (nError) {
     LOGE("[ERROR]:NanoAi_GetGraphAttributes %d\r\n", nError);
     return nError;
   }

   // allocate memory for the graph
   unsigned char* pGraphMem = (unsigned char*)NMALLOC(graphAttributes.requiredMem);
   if (pGraphMem == NULL) {
     LOGE("[ERROR]:MALLOC FAILED\r\n");
     nError = NANOAI_ERROR_INTERNAL;
     return nError;
   }

   // create the graph on the allocated memory
   nError = NanoAi_CreateGraph(NANOAI_MODEL_INSTANCE, NANOAI_MODEL_DATA_INSTANCE, pGraphMem, &nGraph);    
   if (nError) {
     LOGE("[ERROR]:NanoAi_CreateGraph failed %d\r\n", nError);
     return nError;
   }

   // query the input/output graph blob attributes
   nError = NanoAi_GetBlobsAttributes(&nGraph, 0, 0, 0, &blobsAttributes);
   if (nError) {
     LOGE("[ERROR]:NanoAi_GetBlobsAttributes %d\r\n", nError);
     return nError;
   }

   // allocate memory for the input/output graph blobs
   unsigned char* pBlobsMem = (unsigned char*)NMALLOC(blobsAttributes.requiredMem);
   if (pBlobsMem == NULL) {
     LOGE("[ERROR]:MALLOC FAILED\r\n");
     nError = NANOAI_ERROR_INTERNAL;
     return nError;
   }

   // create graph blobs on the allocated memory
   nError = NanoAi_CreateBlobs(&nGraph, pBlobsMem);
   if (nError) {
     LOGE("[ERROR]:NanoAi_CreateBlobs %d\r\n", nError);
     return ret;
   }
```

- **Feed input data**
  
```c
   // no mean or normalization
   nError = NanoAi_Input(&nGraph, mnistTestData[0].data, PIXEL_GRAY, 28, 28, NULL, NULL);
   if (nError) {
     LOGE("[ERROR]:NanoAi_Input %d\r\n", nError);
     return ret;
   }
```

- **Extract output data**
  
```c
   NanoAiOutput nOutput;
   nError = NanoAi_Forward(&nGraph, LENET_INT8_B_PROB_ID, &nOutput);
   if (nError) {
     LOGE("[ERROR]:NanoAi_Forward %d\r\n", nError);
     return ret;
   }
```
